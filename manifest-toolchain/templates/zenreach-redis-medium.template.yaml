version: 1
template:
  id: redis.tf
  contents: |
    {% assign friendly_id = id | replace '_' '-' %}
    module "{{ friendly_id }}" {
      source                     = "../../../modules/elasticache_redis"
      prefix                     = "${module.zenreach.prefix}"
      name                       = "{{ friendly_id }}"
      env                        = "${module.zenreach.env}"
      client_security_group_ids  = ["${data.terraform_remote_state.ecs.services_security_group_id}"]
      subnet_ids                 = ["${data.terraform_remote_state.net.elasticache_subnet_ids}"]
      management_security_groups = ["${data.terraform_remote_state.net.management_security_group_ids}"]
      num_cache_nodes            = {{ num_nodes | default: 2 }}
      node_type                  = "{{ instance_type | default: 'cache.m3.medium' }}"
    }
    
    resource "aws_route53_record" "{{ friendly_id }}" {
      zone_id = "${data.terraform_remote_state.global.hosted_zone_id}"
      name    = "{{ friendly_id }}.${module.zenreach.datacenter}.${data.terraform_remote_state.global.domain}"
      type    = "CNAME"
      ttl     = "300"
      records = ["${module.{{ friendly_id }}.hostname}"]
    }
